name: Patch Samsung A06 5G Kernel with SUSFS

on:
  workflow_dispatch:

jobs:
  patch-susfs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y git patch unzip tar zip wget

      - name: Download Kernel Source (Samsung A06 Release)
        run: |
          set -eux
          wget -O source.zip "https://github.com/huyzilo77-bot/Bufffkerrnela065g/releases/download/V1/A066B-5G.zip"
          unzip -q source.zip

          echo "üìÇ Sau khi gi·∫£i n√©n source.zip:"
          ls -la

          # Gi·∫£i n√©n Kernel.tar.gz ƒë·ªÉ l·∫•y m√£ ngu·ªìn th·∫≠t
          tar -xvf Kernel.tar.gz

          echo "üìÇ Sau khi gi·∫£i n√©n Kernel.tar.gz:"
          ls -la

          # Ki·ªÉm tra th∆∞ m·ª•c kernel-5.15 ƒë√£ t·ªìn t·∫°i ch∆∞a
          if [ -d kernel-5.15 ]; then
            echo "‚úÖ ƒê√£ t√¨m th·∫•y kernel-5.15"
          else
            SRC_DIR=$(find . -maxdepth 1 -type d -name "SM-A066B*" | head -n 1 || true)
            if [ -z "$SRC_DIR" ]; then
              echo "‚ùå Kh√¥ng t√¨m th·∫•y th∆∞ m·ª•c source sau khi gi·∫£i n√©n!"
              exit 1
            fi
            mv "$SRC_DIR" kernel-5.15
          fi

          chmod +x -R kernel-5.15

          echo "üìÇ C·∫•u tr√∫c trong kernel-5.15:"
          ls -la kernel-5.15

      - name: Clone SUSFS
        run: |
          git clone -b gki-android13-5.15 https://gitlab.com/simonpunk/susfs4ksu.git susfs

      - name: Apply SUSFS patches
        run: |
          cd kernel-5.15-patched
          for patch in ../susfs/patches/*.patch; do
            echo "üîß Applying $patch..."
            patch -p1 < "$patch" || true
          done
          cd ..
          echo "üìÇ Checking .rej files..."
          find kernel-5.15-patched -name "*.rej" || true

      - name: Archive results
        run: |
          zip -r kernel-5.15-orig.zip kernel-5.15-orig
          zip -r kernel-5.15-patched.zip kernel-5.15-patched
          zip -r rej-files.zip $(find kernel-5.15-patched -name "*.rej") || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: susfs-results
          path: |
            kernel-5.15-orig.zip
            kernel-5.15-patched.zip
            rej-files.zip
