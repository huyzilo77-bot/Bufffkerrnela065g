name: Build Samsung A06 Kernel (Gốc + KSU + SUSFS + .rej)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Free up Disk
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install Deps & Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl unzip bc build-essential ccache \
            flex bison libssl-dev libncurses5-dev python3

      - name: Setup ccache
        run: |
          export USE_CCACHE=1
          ccache -M 10G
          ccache -z

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: 📥 Download Samsung A06 Kernel Source
        run: |
          mkdir -p kernel-src
          cd kernel-src
          wget -q https://github.com/huyzilo77-bot/Bufffkerrnela065g/releases/download/V1/A066B-5G.zip -O kernel.zip
          unzip -q kernel.zip
          tar -xvf Kernel.tar.gz
          ls -la

      - name: 🌱 Detect Kernel Dir
        id: detect
        run: |
          cd kernel-src
          if [ -d "kernel-5.15" ]; then
            echo "kernel_dir=kernel-5.15" >> $GITHUB_ENV
          elif [ -d "kernel" ]; then
            echo "kernel_dir=kernel" >> $GITHUB_ENV
          else
            echo "❌ Không tìm thấy thư mục kernel!"
            exit 1
          fi

      - name: 🌱 Clone KernelSU-Next & SUSFS
        run: |
          git clone --depth=1 https://github.com/KernelSU-Next/KernelSU-Next.git KernelSU-Next
          git clone --depth=1 https://github.com/sidex15/susfs4ksu-module.git susfs

      - name: 🌱 Apply KernelSU
        run: |
          cd kernel-src/$kernel_dir
          bash ../../KernelSU-Next/kernel/setup.sh || true

      - name: 🌱 Apply SUSFS
        run: |
          cd kernel-src/$kernel_dir
          patch -p1 < ../../susfs/susfs.patch || true

      - name: Save Original, Patched, Rejected
        run: |
          mkdir -p outputs
          # Copy gốc
          cp -r kernel-src/$kernel_dir outputs/original
          # Copy đã vá
          cp -r kernel-src/$kernel_dir outputs/patched
          # Copy file .rej nếu có
          find kernel-src/$kernel_dir -name "*.rej" -exec cp --parents {} outputs/ \; || true

      - name: Upload Original Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Original-Kernel
          path: outputs/original

      - name: Upload Patched Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Patched-Kernel
          path: outputs/patched

      - name: Upload Rejected (.rej)
        uses: actions/upload-artifact@v4
        with:
          name: Rejected
          path: outputs/**/*.rej
