name: Build Samsung A06 Kernel (KSU Next + SUSFS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show repo structure
        run: |
          echo "ðŸ“‚ Current Path: $(pwd)"
          echo "ðŸ“‚ Repo files:"
          ls -R . || true
          echo "ðŸ“‚ Check configs folder:"
          ls -R .github/configs || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl build-essential bc bison flex \
            libssl-dev libncurses5-dev libelf-dev ccache unzip zip jq

      - name: Parse config JSON
        id: parse
        run: |
          CONFIG_FILE=".github/configs/a06.json"

          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Config file $CONFIG_FILE not found!"
            exit 1
          fi

          cat "$CONFIG_FILE"

          KERNEL_REPO=$(jq -r '.repos[0].kernelSource.repo' "$CONFIG_FILE")
          KERNEL_BRANCH=$(jq -r '.repos[0].kernelSource.branch' "$CONFIG_FILE")
          DEFCONFIG=$(jq -r '.repos[0].kernelSource.defconfig' "$CONFIG_FILE")

          echo "KERNEL_REPO=$KERNEL_REPO" >> $GITHUB_ENV
          echo "KERNEL_BRANCH=$KERNEL_BRANCH" >> $GITHUB_ENV
          echo "DEFCONFIG=$DEFCONFIG" >> $GITHUB_ENV

          echo "âœ… Parsed:"
          echo "Repo: $KERNEL_REPO"
          echo "Branch: $KERNEL_BRANCH"
          echo "Defconfig: $DEFCONFIG"

      - name: Clone kernel source
        run: |
          echo "Cloning $KERNEL_REPO branch $KERNEL_BRANCH"
          git clone --depth=1 -b "$KERNEL_BRANCH" "$KERNEL_REPO" kernel
          ls -la kernel
