name: Build Samsung A06 Kernel (KSU Next + SUSFS)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Show repo structure
        run: |
          echo "ðŸ“‚ Current Path: $(pwd)"
          ls -R || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git device-tree-compiler lz4 xz-utils \
            zlib1g-dev openjdk-17-jdk gcc g++ python3 python3-pip \
            p7zip-full android-sdk-libsparse-utils erofs-utils \
            flex bison gperf build-essential curl libssl-dev \
            libncurses5-dev libncursesw5-dev libelf-dev ccache unzip jq

      - name: Clone kernel source
        run: |
          git clone --depth=1 -b main https://github.com/huyzilo77-bot/Samsung-A06-5g-Kernel-5.15.151.git kernel
          ls -la kernel

      - name: Apply KernelSU Next + SUSFS
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/main/setup.sh" | bash -
          curl -LSs "https://gitlab.com/simonpunk/susfs4ksu/-/raw/gki-android13-5.15/susfs.patch" -o susfs.patch
          git apply susfs.patch

      - name: Build kernel
        run: |
          cd kernel
          make ARCH=arm64 a06x_q0_defconfig
          make ARCH=arm64 -j$(nproc)

      - name: Pack with AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          cp -f ../kernel/arch/arm64/boot/Image ./zImage
          zip -r9 ../A06-Kernel-KSU-SUSFS.zip ./*

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: A06-Kernel-KSU-SUSFS
          path: A06-Kernel-KSU-SUSFS.zip
